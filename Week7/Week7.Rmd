---
title: "Week 7 - R Maps for Visualizing Spation Information"
author: "Tim Kelleman"
date: "2024-03-20"

output:
  html_document: 
    toc: no
    toc_depth: 4
    toc_float: yes
    fig_width: 8
    fig_caption: yes
    number_sections: yes
    toc_collapsed: yes
    code_folding: hide
    code_download: yes
    smooth_scroll: true
    theme: readable
   
  pdf_document: 
    toc: no
    toc_depth: 4
    fig_caption: yes
    number_sections: yes
    fig_width: 5
    fig_height: 4
---

```{=html}
<style type="text/css">

div#TOC li {
    list-style:none;
    background-color:lightgray;
    background-image:none;
    background-repeat:none;
    background-position:0;
    font-family: Arial, Helvetica, sans-serif;
    color: #780c0c;
}

/* mouse over link */
div#TOC a:hover {
  color: red;
}

/* unvisited link */
div#TOC a:link {
  color: blue;
}



h1.title {
  font-size: 24px;
  color: Darkblue;
  text-align: center;
  font-family: Arial, Helvetica, sans-serif;
  font-variant-caps: normal;
}
h4.author { 
    font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkRed;
  text-align: center;
}
h4.date { 
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
  text-align: center;
}
h1 {
    font-size: 24px;
    font-family: "Times New Roman", Times, serif;
    color: darkred;
    text-align: center;
}
h2 {
    font-size: 18px;
    font-family: "Times New Roman", Times, serif;
    color: navy;
    text-align: left;
}

h3 { 
    font-size: 15px;
    font-family: "Times New Roman", Times, serif;
    color: navy;
    text-align: left;
}

h4 { /* Header 4 - and the author and data headers use this too  */
    font-size: 18px;
    font-family: "Times New Roman", Times, serif;
    color: darkred;
    text-align: left;
}

/* unvisited link */
a:link {
  color: green;
}

/* visited link */
a:visited {
  color: green;
}

/* mouse over link */
a:hover {
  color: red;
}

/* selected link */
a:active {
  color: yellow;
}
</style>
```
---
```{r setup, include=FALSE}
# code chunk specifies whether the R code, warnings, and output 
# will be included in the output files.
options(repos = list(CRAN="http://cran.rstudio.com/"))
if (!require("tidyverse")) {
   install.packages("tidyverse")
   library(tidyverse)
}
if (!require("knitr")) {
   install.packages("knitr")
   library(knitr)
}
if (!require("cowplot")) {
   install.packages("cowplot")
   library(cowplot)
}
if (!require("latex2exp")) {
   install.packages("latex2exp")
   library(latex2exp)
}
if (!require("plotly")) {
   install.packages("plotly")
   library(plotly)
}
if (!require("gapminder")) {
   install.packages("gapminder")
   library(gapminder)
}
if (!require("png")) {
    install.packages("png")             # Install png package
    library("png")
}
if (!require("RCurl")) {
    install.packages("RCurl")           # Install RCurl package
    library("RCurl")
}
if (!require("colourpicker")) {
    install.packages("colourpicker")              
    library("colourpicker")
}
if (!require("gifski")) {
    install.packages("gifski")              
    library("gifski")
}
if (!require("magick")) {
    install.packages("magick")              
    library("magick")
}
if (!require("grDevices")) {
    install.packages("grDevices")              
    library("grDevices")
}
### ggplot and extensions
if (!require("ggplot2")) {
    install.packages("ggplot2")              
    library("ggplot2")
}
if (!require("gganimate")) {
    install.packages("gganimate")              
    library("gganimate")
}
if (!require("ggridges")) {
    install.packages("ggridges")              
    library("ggridges")
}
if (!require("graphics")) {
    install.packages("graphics")              
    library("graphics")
}
if (!require("dplyr")) {
    install.packages("dplyr")              
    library("dplyr")
}
if (!require("lubridate")) {
    install.packages("lubridate")              
    library("lubridate")
}
if (!require("tmap")) {
    install.packages("tmap")              
    library("tmap")
}
if (!require("sf")) {
    install.packages("sf")              
    library("sf")
}

if (!require("leaflet")) {
    install.packages("leaflet")              
    library("leaflet")
}
knitr::opts_chunk$set(echo = TRUE,       
                      warning = FALSE,   
                      result = TRUE,   
                      message = FALSE,
                      comment = NA)
```
# Gas Station Point of Compromise {.tabset}
The original “Gas Station - Point of Compromised (POC)” data set contained 72,798 observations. A random 500 observations were selected to display on the map below based on the latitude and longitude of the observation. Size of marker and color of marker are proportional to the number of POCs in the ZIP code. 
<br>
<br>
Using the hover over each of the markers it displays State, County, Address, Zip Code, and Area Type. Viewing these descriptions it is clear there are more POCs in "urban" areas as opposed to "urban" areas. This data correlates with the more populated regions of the United States.
```{r eval=TRUE}
#Import data
poc<- read.csv("https://tkelleman.github.io/tkweb/Week7/POC.csv")
#Select 500 observations at random
poc.rand500<-poc[sample(nrow(poc),500),]


geostyle<- list(scope = 'usa',
              projection = list(type = 'albers usa'),
              showland = TRUE,
              landcolor = toRGB("gray95"),
              subunitcolor = toRGB("gray85"),
              countrycolor = toRGB("gray85"),
              countrywidth = 0.5,
              subunitwidth = 0.5
            )
map<- plot_geo(poc.rand500, lat = ~ycoord, lon = ~xcoord) %>% 
  add_markers(text = ~paste("State:", STATE, 
                            "<br>County:", county, 
                            "<br>Address:", ADDRESS, 
                            "<br>Zip Code:", ZIPnew,
                            "<br>Area Type:", description
                            ),
              color = ~ZIPPOC, 
              symbol = "circle", 
              size = ~ZIPPOC, 
              hoverinfo = "text")   %>% 
  colorbar(title = "Number of POC <br>at each Zip Code")  %>% 
  layout( title = 'Gas Station - Point of Compromise', 
          geo = geostyle)
map
```
<br>

# Philadelphia Crime Data {.tabset}
To generate the appropriate subset of data from the original “Philly Crime Data (2015-2024)” data set the incomplete observations were removed using na.omit.  The date needed to be extracted using the “lubridate” package. Once the date was properly formatted, the data was filtered to include only observations from the year 2023. 
<br>
<br>
In this map it is clear that “nonfatal” crimes are more common than “fatal” in Philadelphia, but there isn’t much a of a trend based on neighborhood. There are however some pockets within the city without any observations that indicate they are either safer areas of the city or lacking data.
```{r eval=TRUE}
#Import data
#Read the Philly Crime data
phillyCrime <- na.omit(read.csv("https://tkelleman.github.io/tkweb/Week7/PhillyCrimeSince2015.csv"))

# Extract the year from the date
y <- mdy_hm(phillyCrime$date)
phillyCrime$year <- year(y)

# Filter data for 2023
phillyCrime.2023 <- filter(phillyCrime, year == 2023)


phillyCrime.2023$color <- ifelse(phillyCrime.2023$fatal == "Fatal", "#118ab2", "#ffd166")

label.msg<- label.msg <- paste("Neighborhood:", phillyCrime.2023$neighborhood,    
                   "<br> Zip Code:", phillyCrime.2023$zip_code, 
                   "<br> Street Name:", phillyCrime.2023$street_name)

# Create leaflet map
leaflet(phillyCrime.2023) %>%
  addProviderTiles(providers$OpenStreetMap) %>% 
  setView(
            lng = mean(phillyCrime.2023$lng), 
            lat = mean(phillyCrime.2023$lat), 
            zoom = 11) %>%
  addCircleMarkers(
            color = "black",
            fillColor = ~color,
            #radius = 
            stroke = TRUE, 
            weight = 1,
            fillOpacity = 0.8,
            label = label.msg)  %>%
  addLegend(
            position = "bottomright", 
            colors = c("#118ab2", "#ffd166"),
            labels= c("Fatal", "Nonfatal"),
            title= "Fatal & Nonfatal Crimes in Philadelphia",
            opacity = 0.6) %>%
  addControl(
            html = "<div class='map-title'>Leaflet Map of Crime in Philadelphia <br>by Fatal and Nonfatal   Crimes</div>",
            position = "topleft"
  )
```